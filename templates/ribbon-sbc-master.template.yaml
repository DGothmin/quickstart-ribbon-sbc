---
AWSTemplateFormatVersion: '2010-09-09'
Description: AWS CloudFormation Template to setup and deploy vSBC HA instances and
  2 PKTART instances to test vSBC. This template creates required vpc, subnet and
  other routing elements required IAM role to performce IP movement betweenn two vSBC
  instances.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: SBC Configuration
        Parameters:
          - SBCInstanceType
          - KeyPairName
      - Label:
          default: Bastion Configuration
        Parameters:
          - BastionAMIOS
      - Label:
          default: Network Configuration
        Parameters:
          - VPCCIDR
          - HFEPublicCIDR1
          - HFEPublicCIDR2
          - ManagementSubnetCIDR
          - SBCHASubnetCIDR
          - SBCExVoipCIDR
          - SBCAvailabilityZone
      - Label:
          default: 'Optional: SBC configuration. For default configuration no need
            to change these values.'
        Parameters:
          - SBCPersonalityType
          - SBCActiveInstanceName
          - SBCPassiveInstanceName
          - SBCSystemName
          - SBCVolumeType
          - SBCVolumeIOPS
          - SBCVolumeSize
Parameters:
  # VPC.
  KeyPairName:
    Description: 'Name of an existing EC2 KeyPair to enable SSH access to the SBC
      and Mangler instance '
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  SBCCLIPassword:
    Type: String
  BastionAMIOS:
    Default: "Amazon-Linux-HVM"
    AllowedValues:
      - Amazon-Linux-HVM
      - CentOS-7-HVM
      - Ubuntu-Server-14.04-LTS-HVM
      - Ubuntu-Server-16.04-LTS-HVM
    Type: String
    Description: "The Linux distribution for the AMI to be used for the bastion instances"
  BastionInstanceType:
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
    Default: t2.micro
    Description: "Amazon EC2 instance type for the bastion instances."
    Type: String
  VPCCIDR:
    Description: VPC CIDR block for new VPC that will be used to create SBC and PKTART
      test tool.
    Type: String
    Default: 10.74.0.0/16
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x.
  SBCExVoipCIDR:
    Description: Enter a CIDR for pirvate subnet for SBC, this new subnet will be
      served by Mangler instance.
    Type: String
    MinLength: '1'
    Default: 10.74.10.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  SBCInVoipCIDR:
    Description: Enter a CIDR for pirvate subnet for SBC, this new subnet will be
      served by Mangler instance.
    Type: String
    MinLength: '1'
    Default: 10.74.11.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  HFEPublicCIDR1:
    Description: Enter a CIDR for private subnet for SBC, this new subnet will be
      served by Mangler instance.
    Type: String
    MinLength: '1'
    Default: 10.74.12.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  HFEPublicCIDR2:
    Description: Enter a CIDR for private subnet for SBC, this new subnet will be
      served by Mangler instance.
    Type: String
    MinLength: '1'
    Default: 10.74.13.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  HFEPrivateCIDR:
    Description: Enter a CIDR for pirvate subnet for SBC, this new subnet will be
      served by Mangler instance.
    Type: String
    MinLength: '1'
    Default: 10.74.14.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  ManagementSubnetCIDR:
    Description: CIDR used within the Management Subnet
    Type: String
    MinLength: '1'
    Default: 10.74.15.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  SBCHASubnetCIDR:
    Description: CIDR used within the SBC High Availability subnet.
    Type: String
    MinLength: '1'
    Default: 10.74.16.0/28
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  SBCExternalVoipCIDR:
    Description: CIDR used within the SBC External Voip (public facing) subnet.
    Type: String
    MinLength: '1'
    Default: 10.74.17.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  SBCInternalVoipCIDR:
    Description: CIDR used within the SBC Internal Voip (private) subnet.
      served by Mangler instance.
    Type: String
    MinLength: '1'
    Default: 10.74.18.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  PublicHFEPacketSubnetCIDR:
    Description: CIDR used within the HFE Public Subnet.
    Type: String
    MinLength: '1'
    Default: 10.74.19.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  PrivateHFESubnetCIDR:
    Description: CIDR used for the HFE Private Subnet.
    Type: String
    MinLength: '1'
    Default: 10.74.20.0/24
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x and
      subnet of VPC.
  RemoteAccessCIDR:
    Description: CIDR used to access the bastion instance.
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x.
  HFEManagementNeedsEIP:
    Description: Enable EIP on the management interface of the HFE instance(s)?
    Type: String
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  HFEManagementEIPAccessCIDR:
    Description: The CIDR range used to access the HFE Management EIP.
    Type: String
    Default: '127.0.0.1/32'
    AllowedPattern: '^((\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])(\/(\d|[1-2]\d|3[0-2]))$'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x
  # TODO: Removed in leiu of VPC Template. come back to this.
  SBCAvailabilityZone:
    Description: Enter Availability Zone for SBC, New subnets for SBC will be created
      here.
    Type: AWS::EC2::AvailabilityZone::Name
  SBCInstanceType:
    Description: Instance type for the SBC Mangler.
    Type: String
    Default: m5.xlarge
    AllowedValues:
      - m4.xlarge
      - m5.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.8xlarge
    ConstraintDescription: Must be a valid EC2 instance type.
  SBCPersonalityType:
    Description: SBC Personality Type. Currently only supports 'isbc' (Integrated). Distributed is currently not supported.
    Type: String
    Default: isbc
    AllowedValues:
      - isbc
    ConstraintDescription: Must be a valid SBC Personality type.
  SBCActiveInstanceName:
    Description: CE name of the active instance
    Type: String
    Default: vsbc1
    MaxLength: '63'
    AllowedPattern: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$
    ConstraintDescription: 'Enter valid ceName(instance name).  Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$'
  SBCPassiveInstanceName:
    Description: CE name of the standby instance
    Type: String
    Default: vsbc2
    MaxLength: '63'
    AllowedPattern: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$
    ConstraintDescription: 'Enter valid ceName(instance name).  Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$'
  SBCSystemName:
    Description: System Name
    Type: String
    Default: vsbcSystem
    MaxLength: '26'
    AllowedPattern: ^[A-Za-z]{1}[-A-Za-z0-9]*[A-Za-z0-9]{1}$
    ConstraintDescription: 'Enter valid system name.  Regex: ^[A-Za-z]{1}[-A-Za-z0-9]*[A-Za-z0-9]{1}$ '
  # TODO: Rename. De-couple scope.
  SSHAccessCIDR:
    Description: IP CIDR from where you could SSH into SBC and PKTART instances
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: '127.0.0.1/32'
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid CIDR range of the form x.x.x.x/x.
  SBCVolumeType:
    Description: Select Type of Volume for SBC
    Type: String
    Default: io1
    AllowedValues:
      - gp2
      - io1
  CreateVPCEndPoint:
    Description: Do you want to create VPC End-point to access API server? if you
      select no then SBC will reach API server using EIP on mgt0 ports
    Type: String
    Default: 'yes'
    AllowedValues:
      - 'yes'
      - 'no'
  SBCVolumeIOPS:
    Description: Enter IOPS reservation for IO1 type EBS volume [<= 1950]. This value is ignored for GP2 type volumes.
    Type: Number
    Default: '600'
    MaxValue: '1950'
  SBCVolumeSize:
    Description: Enter size of disk in GiB. Minimum disk required is 65 GiB
    Type: Number
    Default: '65'
    MinValue: '65'
    MaxValue: '1000'
  QSS3BucketName:
    Type: String
    Default: aws-quickstart
  QSS3KeyPrefix:
    Type: String
    Default: quickstart-ribbon-sbc/
Conditions:
  # This condition is not used.
  EipOnPkt0: !Equals
    - 'true'
    - 'true'
  VolumeTypeIO1: !Equals
    - !Ref 'SBCVolumeType'
    - io1
  CreateVPCEndPoint: !Equals
    - !Ref 'CreateVPCEndPoint'
    - 'yes'
  EipForHFEManagementInterface: !Equals
    - !Ref 'HFEManagementNeedsEIP'
    - 'Yes'
  noVPCEndPointForMgt: !Equals
    - !Ref 'CreateVPCEndPoint'
    - 'no'
Rules:
  NameMismatch:
    Assertions:
      - Assert:
          Fn::Not:
            - Fn::Equals:
              - !Ref 'SBCActiveInstanceName'
              - !Ref 'SBCPassiveInstanceName'
        AssertionDescription: "SBCActiveInstanceName and SBCPassiveInstanceName must be unique"
      - Assert:
          Fn::Not:
            - Fn::Equals:
              - !Ref 'SBCActiveInstanceName'
              - !Ref 'SBCSystemName'
        AssertionDescription: "SBCActiveInstanceName and SBCSystemName cannot be the same."
      - Assert:
          Fn::Not:
            - Fn::Equals:
              - !Ref 'SBCPassiveInstanceName'
              - !Ref 'SBCSystemName'
        AssertionDescription: "SBCPassiveInstanceName and SBCSystemName cannot be the same."
Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: "https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/ribbon-custom-vpc.yaml"
      Parameters:
        AvailabilityZone: !Ref 'SBCAvailabilityZone'
        PublicSubnet1CIDR: !Ref 'HFEPublicCIDR1'
        PublicSubnet2CIDR:  !Ref 'HFEPublicCIDR2'
        PrivateSubnet1CIDR: !Ref 'SBCHASubnetCIDR'
        PrivateSubnet2CIDR: !Ref 'SBCExternalVoipCIDR'
        PrivateSubnet3CIDR: !Ref 'SBCInternalVoipCIDR'
        PrivateSubnet4CIDR: !Ref 'ManagementSubnetCIDR'
        PublicSubnetTag1: 'Name=Quickstart-Ribbon-SBC'
        PrivateSubnetTag1: 'Name=Quickstart-Ribbon-SBC'
        VPCCIDR: !Ref 'VPCCIDR'
  # Subnets:
  # - Public Subnet (Bastion / HFE eth0) [x]
  # - External VOIP
  # - Internal VOIP
  # - Management
  # - HA [x]
#  SBCInVoipSubnet:
#    # Private Subnet
#    Type: AWS::EC2::Subnet
#    Properties:
#      VpcId: !GetAtt
#      - VPCStack
#      - Outputs.VPCID
#      CidrBlock: !Ref 'SBCInternalVoipCIDR'
#      AvailabilityZone: !Ref 'SBCAvailabilityZone'
#      Tags:
#      - Key: Name
#        Value: !Sub "${SBCSystemName}-External Voip (ExVoip) Subnet"
#  SBCExVoipSubnet:
#    # Private Subnet
#    Type: AWS::EC2::Subnet
#    Properties:
#      VpcId: !GetAtt
#        - VPCStack
#        - Outputs.VPCID
#      CidrBlock: !Ref 'SBCExternalVoipCIDR'
#      AvailabilityZone: !Ref 'SBCAvailabilityZone'
#      Tags:
#        - Key: Name
#          Value: !Sub "${SBCSystemName}-External Voip (ExVoip) Subnet"
#  SBCManagementSubnet:
#    # Private Subnet
#    Type: AWS::EC2::Subnet
#    Properties:
#      VpcId: !GetAtt
#        - VPCStack
#        - Outputs.VPCID
#      CidrBlock: !Ref 'ManagementSubnetCIDR'
#      AvailabilityZone: !Ref 'SBCAvailabilityZone'
#      Tags:
#        - Key: Name
#          Value: !Sub "${SBCSystemName}-Management Subnet"
  BastionStack:
    DependsOn: VPCStack
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-linux-bastion/templates/linux-bastion.template"
      Parameters:
        BastionAMIOS: !Ref BastionAMIOS
        BastionInstanceType: !Ref BastionInstanceType
        KeyPairName: !Ref KeyPairName
        PublicSubnet1ID: !GetAtt
          - VPCStack
          - Outputs.PublicSubnet1ID
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix:  !Sub "${QSS3KeyPrefix}submodules/quickstart-linux-bastion/"
        VPCID: !GetAtt
          - VPCStack
          - Outputs.VPCID
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        PublicSubnet2ID: !GetAtt
          - VPCStack
          - Outputs.PublicSubnet2ID
  SBCStack:
    DependsOn: VPCStack
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}templates/ribbon-sbc.yaml"
      Parameters:
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        PublicSubnet: !GetAtt
          - VPCStack
          - Outputs.PublicSubnet1ID
        KeyPairName: !Ref KeyPairName
        BastionSecurityGroupID: !GetAtt
          - BastionStack
          - Outputs.BastionSecurityGroupID
        SBCExVoipSubnet: !GetAtt
          - VPCStack
          - Outputs.PublicSubnet2ID
        SBCInVoipSubnet: !GetAtt
          - VPCStack
          - Outputs.PrivateSubnet3ID
        SBCManagementSubnet: !GetAtt
          - VPCStack
          - Outputs.PrivateSubnet4ID
        SBCHASubnet: !GetAtt
          - VPCStack
          - Outputs.PrivateSubnet1ID
        SSHAccessCIDR: !Ref SSHAccessCIDR
        VPCID: !GetAtt
          - VPCStack
          - Outputs.VPCID
        SBCCLIPassword: !Ref SBCCLIPassword